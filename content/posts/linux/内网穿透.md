---
title: "实验室网络解析 （内网穿透）"
subtitle: ""
date: 2022-10-07T22:41:49+08:00
lastmod: 2022-10-07T22:41:49+08:00
draft: false
toc:
  enable: true
weight: false
categories: ["网络","linux"]
tags: ["网络","linux","实验室"]
---

&emsp;&emsp;之前师兄在群里发了学校实验室两台服务器和之江实验室两台服务器的SSH连接方法，讲了在实验室怎么连和在外面怎么连。当时就觉得很高级，也没有细品为什么要这么连，内外网跳板机是如何实现的...后来师兄[爱飞的鸟](https://blog.aflybird.cn/)在一台闲置主机上装了Linux用作服务器，并配置了内网穿透，使得外网也能连接这台主机。我当时还不懂实验室外网跳板机和师兄配置内网穿透这两者的关系，后来请教师兄后才豁然开朗，它们原来是一样的！


&emsp;&emsp;于是我也找了台实验室闲置的主机（最后一台了hhh），装了Linux系统，配置了内网穿透，然后我也拥有了一台16GB内存的服务器😍。这篇文章就来梳理一下实验室的网络情况以及实现原理，顺便写一下最近电脑重装系统后一些环境的配置。

## 一、内网、外网、跳板机、ssh

这是实验室的网络拓扑情况：

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;![网络拓扑](/实验室网络解析（内网穿透）/a.png)

&emsp;&emsp;我们实验室的电脑，不管是连接无线网i-HDU，还是插网线连接网络，都会进入学校内网，IP地址为10.X.X.X；之江实验室也同样有属于他们自己的内网。用户主机2为在实验室（即在学校内网中）的电脑，用户主机3为外网的电脑。主机J既是内网跳板机又是外网跳板机，它能访问zjlab内网，也能被外网的主机所访问。基于以上情况，产生了以下问题：

1. 用户主机2如何连接服务器A、B？
2. 用户主机2如何连接服务器C、D？
3. 用户主机3如何连接服务器A、B?
4. 用户主机3如何连接服务器C、D？
5. 用什么工具连？怎么连？
6. 跳板机是什么？有什么作用？
7. 主机j是如何实现内网跳板机的？
8. 主机j是如何实现外网跳板机的？

> 1.用户主机2如何连接服务器A、B？

&emsp;&emsp;它们都处在同一个hdu内网之中，互相是能识别各自10.X.X.X的IP地址的，所以可以直接访问。

> 2.用户主机2如何连接服务器C、D？

&emsp;&emsp;服务器C、D在之江内网，而内网跳板机能访问zjlab；内网跳板机在hdu内网中，因此主机2能直接访问内网跳板机。所以，主机2就可以用内网跳板机当作跳板，来连接服务器C、D。

> 3.用户主机3如何连接服务器A、B?

&emsp;&emsp;主机3在外网，它能访问到外网跳板机，外网跳板机在hdu内网，因此主机3可以用外网跳板机当跳板，来连接hdu内网的服务器C、D。

> 4.用户主机3如何连接服务器C、D？

&emsp;&emsp;主机3能连接外网跳板机，而外网跳板机和内网跳板机其实是同一台主机J，因此外网跳板机还能访问zjlab。所以，主机3还可以通过外网跳板机来连接服务器C、D。

> 5.用什么工具连？怎么连？

&emsp;&emsp;通过ssh远程连接的工具有很多，比如terminal终端、xshell、termius、vscode等。个人用下来觉得vscode最好用，因为可以直接操作服务器里的文件。当然只是shell操作的话，用termius也很方便（比xshell好用很多），但是termius需要去申请一个github学生包的会员，我觉得挺难申请的。下面只介绍vscode连接方法。

&emsp;&emsp;vscode远程连接需要下载remote-ssh插件，下载完成后按[VSCode Remote ssh跳板机配置](https://zhuanlan.zhihu.com/p/103578899)所说配置即可。

&emsp;之后可以再去搜索一下`vscode ssh 免密登录`，将主机的公匙放到服务器`用户主目录/.ssh/authorized_keys`中即可，可参考[vscode设置remote-ssh并免密登录](https://blog.csdn.net/weixin_42397613/article/details/114983147)。这里我**遇到了一个坑**，明明我配置好了，但是免密登录一直都没有生效，后来翻了很多博客，发现有些博客有`sudo chmod 700 ~/。ssh`这一步，我执行后，免密登录就成功了。我觉得大概率原本的.ssh文件没有执行权限，所以进不去。

&emsp;以下是我实验室主机的部分config文件（“打码”处理了，内网穿透本身就不安全，万一导致实验室被网络攻击沦陷了就g了🤡）。（连接腾讯云服务器需要跳，是因为学校内网不允许我们直接ssh连接外网的服务器）。

```yml
Host 内网跳板机J
    # 跳板机的ip地址
    HostName 10.XXX.XXX.XXX
    # 你跳板机的用户名
    User J
    # 跳板机登录端口 
    Port 22

Host zjlabC    
    # 目标机的ip地址
    HostName 10.XXX.XXX.XXX
    # 你目标机的用户名
    User serverC
    # 目标机登录端口 
    Port 22
    ProxyCommand C:\Windows\System32\OpenSSH\ssh.exe  -W %h:%p 内网跳板机J

Host 腾讯云服务器
    # 目标机的ip地址
    HostName koisecret.site
    # 你目标机的用户名
    User me
    # 目标机登录端口 
    Port 22
    ProxyCommand C:\Windows\System32\OpenSSH\ssh.exe  -W %h:%p zjlabC
```

&emsp;以下是我外网笔记本的部分config文件

```yml
Host 外网跳板机J
    # 跳板机的ip地址
    HostName 124.222.XXX.XXX     # 是个公网ip地址
    # 你跳板机的用户名
    User J
    # 跳板机登录端口 
    Port 22
    
Host zjlabC    
    # 目标机的ip地址
    HostName 10.XXX.XXX.XXX
    # 你目标机的用户名
    User serverC
    # 目标机登录端口 
    Port 22
    ProxyCommand C:\Windows\System32\OpenSSH\ssh.exe  -W %h:%p 外网跳板机J
```

&emsp;可以根据配置文件，理解一下到底是怎么连的。

> 6.跳板机是什么？有什么作用？

&emsp;简单来说，跳板机就是一个桥梁，他和她无法交流，你和她、你和他能交流，你就去当个跳板机，他和她就能交流了。其实，任何电脑都能当跳板机，无需任何配置，只要一台电脑能访问到另一台电脑，你就可以通过这台电脑去访问那台电脑。就像之江实验室的服务器zjlabC可以直接访问到我的腾讯云服务器，那么无需任何配置，在实验室内网的主机2，就能以zjlabC为跳板机连接腾讯云服务器。

> 7.主机j是如何实现内网跳板机的？

&emsp;也就是说，主机j是如何能访问之江内网的？其实很简单，想想你在外网是怎么连接学校图书馆来查文献的？------vpn。下载easyconnect登录学生账号就可以连接学校的内网了。内网跳板机也就是在主机上下载easyconnect，登录之江实验室的账号密码就可以了。

> 8.主机j是如何实现外网跳板机的？

&emsp;也就是说，主机j是如何能被外网访问的？-----内网穿透！采用内网穿透技术，就能在外网直接连接主机j了，然后就能以主机j为跳板，来访问主机j能访问到的机器（也就是hdu内网和zjlab内网中的所以主机）。

**&emsp;因此，我在实验室配了一台Linux主机1，明明需求是内网穿透从而外网能直接连接Linux主机1，没想到Linux主机1它还能充当外网跳板机。**（当然我也能通过跳板机j来连接主机1）



##  二、配置内网穿透前了解的Linux知识

### Linux权限

查看目录下文件的权限命令：`ls -a`



















## 三、frp内网穿透

ddd

## 四、简单记录一些环境、软件的配置 leetcode

1、ubuntu 安装 ssh 服务
$ sudo apt-get install openssh-server

2、ubuntu 启动 ssh 服务
$ sudo service ssh start

3、ubuntu ssh 服务加入开机启动
$ sudo systemctl enable ssh

4、ubuntu 关闭防火墙
sudo ufw disable





1. 内网穿透后 密码不一致时
2. frp 报错、nohup





