---
title: "记录第一次开源经历"
subtitle: ""
date: 2022-11-01T15:49:19+08:00
lastmod: 2022-11-01T15:49:19+08:00
draft: false
toc:
  enable: true
weight: false
categories: ["开源"]
tags: ["开源","docker","部署运维"]
featuredImage: ""
---

&emsp;&emsp;好久没写博客了，这半个月确实有点浪，剧本杀阿瓦隆喝酒唱歌聚餐样样没落下，还“努力”上了个王者，简直读了个假研究生。

&emsp;&emsp;不过这半个月里，我也完成了一个开源任务，给[hmily-admin](https://github.com/dromara/hmily-admin)增加`docker打包`部署方式，提交了pr并合并了。老早就在师兄的安利下，想要接触开源了，这次算是第一次真正参与了一个开源项目，虽然这个只是个小项目（属于[hmily](https://github.com/dromara/hmily)的展示平台），但也收获了挺多东西。

![第一个合并的pr](/开源/first.png)

### 一、需求分析

`hmily-admin`原本是一个单体项目，部署方式是将项目打包成一个zip包，再通过shell脚本的方式来启动。这种方式比起上传jar包，再通过命令行的方式运行，确实是方便了一点。

我的任务是，仿照[apache/shenyu](https://github.com/apache/shenyu)，给`hmily-admin`增加`docker打包`部署方式以及完善相应文档。

`shenyu`的docker部署只需要`make build-all-image`一条命令，就能将项目打包成镜像了，接下来就是通过`docker run`时**传入配置文件参数**或**绑定数据卷**的方式，跑起服务。shenyu是通过`Makefile` + `打包模块`来实现的，我仿照shenyu实现了hmily-admin的docker部署。

### 二、操作步骤

> 1.更改项目结构

&emsp;&emsp;由于需要新建打包模块，需要将原来的单体项目修改为多模块项目，这个可以去参考一下微服务项目的构建方法。

> 2.新建`hmily-admin-dist`模块

&emsp;&emsp;基本照抄shenyu的打包模块，改的地方只有路径、项目名、主启动类名等。我认为这个模块最重要的就是`maven-assembly-plugin`插件以及`binary.xml`文件，至于具体是怎么生成目标文件的，我准备之后研究研究，可以期待一下我的后续博客。

> 3.编写Makefile与Dockerfile

- **Makefile**

&emsp;&emsp;Makefile主要来完成两件事情：maven打包项目、docker生成镜像。Makefile文件如下：

```makefile
HMILY_HOME :=  "."
REGISTRY ?= "docker.io"
REPOSITORY_PREF ?= "dromara/hmily"
ADMIN_REPOSITORY ?= "${REPOSITORY_PREF}-admin"
TAG ?= latest
VERSION ?= "1.0.2"
COMMIT_ID := $(shell git rev-parse HEAD)


default: build-hmily-admin-image
# docker生成镜像
build-hmily-admin-image: build-hmily-admin
	@echo "build-hmily-admin-image"
	@docker buildx build --load \
    		-t ${REGISTRY}/${ADMIN_REPOSITORY}:${TAG} \
    		-f ${HMILY_HOME}/hmily-admin-dist/docker/Dockerfile \
    		--build-arg APP_NAME=hmily-admin-${VERSION}-admin-bin \
    		--label "commit.id=${COMMIT_ID}" \
    		${HMILY_HOME}/hmily-admin-dist

# maven打包项目
build-hmily-admin:
	@echo "build hmily admin"
	@mvn -am \
		-pl hmily-admin-dist \
		-Dmaven.javadoc.skip=true \
		-Drat.skip=true \
		-Djacoco.skip=true \
		-DskipTests \
		-Prelease \
		clean package
```

&emsp;&emsp;maven打包项目：指定了打包的模块是`hmily-admin-dist`，`-Prelease`用来指定pom文件中的`release`方式，用于生成`hmily-admin-1.0.2-admin-bin.tar.gz`。

&emsp;&emsp;docker生成镜像：指定Dockerfile的位置，通过Dockerfile生成镜像。

- **Dockerfile**

&emsp;&emsp;将生成`hmily-admin-1.0.2-admin-bin.tar.gz`add到镜像中，配置`entrypoint.sh`，使得用户能通过命令行传入需要配置的信息，如数据库用户密码等。现在的entrypoint.sh还是有改进空间的，因为用户能传入的内容还不足以覆盖全部的配置信息。

> 4.运行测试

&emsp;&emsp;如何运行可参考[README.md](https://github.com/chengsecret/hmily-admin/blob/master/QuickStart.md)。运行过程中也遇到了几个问题：

- `self4j-log4j12`依赖冲突问题。通过`mvn dependency:tree`命令查找哪个依赖中还有self4j-log4j12包，剔除就好。**`mvn dependency:tree`命令很重要，依赖冲突时能排查！**
- `-v`数据卷绑定方式传入配置文件，控制台日志不输出问题。后来发现日志输出在容器的`/opt/log`目录下，再建立一个日志的数据卷，就能方便查看日志文件了。



### 三、遇到的问题与收获

#### 1. maven命令

mvnw   install    -p 

#### 2. 项目打包插件



#### 3. 脚本



#### 4. 依赖冲突问题



#### 5.数据卷



#### 6. 沟通的重要性





### 四、后续





















